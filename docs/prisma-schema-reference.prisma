// Orbitus Classroom RPG - Schema de referÃªncia (Prisma)
// Colocar em apps/api/prisma/schema.prisma ao implementar

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  VIEWER
}

enum StudentStatus {
  active
  inactive
  archived
}

enum BlockerStatus {
  active
  resolved
}

enum GoalStatus {
  pending
  in_progress
  completed
}

enum AvatarType {
  template
  emoji
  photo
}

model TeacherUser {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String  @map("password_hash")
  role         Role     @default(ADMIN)
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  studentsCreated Student[]     @relation("StudentCreatedBy")
  lessons         Lesson[]
  blockers        Blocker[]
  goals           Goal[]

  @@map("teacher_users")
}

model ClassGroup {
  id             String   @id @default(cuid())
  name           String
  course         String?
  academicPeriod String?  @map("academic_period")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  students Student[]

  @@map("class_groups")
}

model Student {
  id              String        @id @default(cuid())
  classGroupId    String?       @map("class_group_id")
  teacherUserId   String        @map("teacher_user_id")
  displayName     String        @map("display_name")
  fullName        String?       @map("full_name")
  avatarType      AvatarType    @default(template) @map("avatar_type")
  avatarValue     String        @map("avatar_value")
  photoUrl        String?       @map("photo_url")
  level           Int           @default(1)
  xp              Int           @default(0)
  status          StudentStatus @default(active)
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  classGroup   ClassGroup?   @relation(fields: [classGroupId], references: [id], onDelete: SetNull)
  teacherUser  TeacherUser   @relation("StudentCreatedBy", fields: [teacherUserId], references: [id], onDelete: Restrict)
  lessons      Lesson[]
  skillProgress SkillProgress[]
  blockers     Blocker[]
  goals        Goal[]

  @@index([teacherUserId])
  @@index([classGroupId])
  @@index([status])
  @@index([level])
  @@map("students")
}

model Topic {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  xpWeight  Float    @default(1) @map("xp_weight")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  skills TopicSkill[]
  lessons Lesson[]

  @@map("topics")
}

model Skill {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  color     String?  // hex
  sortOrder Int      @default(0) @map("sort_order")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  topics  TopicSkill[]
  progress SkillProgress[]

  @@map("skills")
}

model TopicSkill {
  topicId  String @map("topic_id")
  skillId  String @map("skill_id")

  topic Topic @relation(fields: [topicId], references: [id], onDelete: Cascade)
  skill Skill @relation(fields: [skillId], references: [id], onDelete: Cascade)

  @@id([topicId, skillId])
  @@map("topic_skills")
}

model Lesson {
  id              String   @id @default(cuid())
  studentId       String   @map("student_id")
  teacherUserId   String   @map("teacher_user_id")
  heldAt          DateTime @map("held_at")
  durationMinutes Int      @map("duration_minutes")
  topicId         String   @map("topic_id")
  rating          Int      // 1-5
  notes           String?  @db.Text
  xpEarned        Int      @map("xp_earned")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  teacherUser TeacherUser @relation(fields: [teacherUserId], references: [id], onDelete: Restrict)
  topic    Topic  @relation(fields: [topicId], references: [id], onDelete: Restrict)

  @@index([studentId, heldAt(sort: Desc)])
  @@map("lessons")
}

model SkillProgress {
  id         String   @id @default(cuid())
  studentId  String   @map("student_id")
  skillId    String   @map("skill_id")
  currentXp  Int      @default(0) @map("current_xp")
  level      Int?     @default(1)
  updatedAt  DateTime @updatedAt @map("updated_at")

  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  skill   Skill   @relation(fields: [skillId], references: [id], onDelete: Cascade)

  @@unique([studentId, skillId])
  @@index([studentId])
  @@map("skill_progress")
}

model Blocker {
  id            String       @id @default(cuid())
  studentId     String       @map("student_id")
  teacherUserId String       @map("teacher_user_id")
  titleOrTopic  String       @map("title_or_topic")
  severity      Int          // 1-3
  tags          String[]     @default([])
  observation   String?      @db.Text
  status        BlockerStatus @default(active)
  resolvedAt    DateTime?    @map("resolved_at")
  resolvedById  String?      @map("resolved_by_id")
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")

  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  teacherUser TeacherUser @relation(fields: [teacherUserId], references: [id], onDelete: Restrict)

  @@index([studentId])
  @@index([status])
  @@map("blockers")
}

model Goal {
  id            String     @id @default(cuid())
  studentId     String     @map("student_id")
  teacherUserId String     @map("teacher_user_id")
  title         String
  description   String?    @db.Text
  status        GoalStatus @default(pending)
  deadlineAt    DateTime?  @map("deadline_at")
  completedAt   DateTime?  @map("completed_at")
  createdAt     DateTime   @default(now()) @map("created_at")
  updatedAt     DateTime   @updatedAt @map("updated_at")

  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  teacherUser TeacherUser @relation(fields: [teacherUserId], references: [id], onDelete: Restrict)

  @@index([studentId])
  @@index([status])
  @@map("goals")
}
